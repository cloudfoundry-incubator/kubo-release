#!/bin/bash -e

PATH=/var/vcap/packages/jq/bin/:$PATH

# Refreshes the BOSH DNS node list with the latest IPs
BOSH_DNS_RECORDS=/var/vcap/instance/dns/records.json
WORKER_DNS_LIST=/var/vcap/jobs/node-dns-aliases/config/bosh_dns_list
KUBE_NODE_LIST=/var/vcap/jobs/node-dns-aliases/config/nodelist
BOSH_DNS_ALIASES=/var/vcap/jobs/node-dns-aliases/dns/aliases.json

# Refresh the BOSH DNS list for each worker job
jq '.records | map ( select (.[] | contains("worker")) | { "InternalIP": .[0], "BOSH_DNS": .[1]  } )' $BOSH_DNS_RECORDS > $WORKER_DNS_LIST

# This joins the BOSH DNS node list with the kubectl nodes list.
# The join/common field is the InternalIP.
# It then mangles the results to make the hostname the key and BOSH DNS (in an array) the value,
# per the aliases.json format
jq -s '[ .[0] + .[1] | group_by(.InternalIP)[] | add ]' $KUBE_NODE_LIST $WORKER_DNS_LIST | jq '.[] | to_entries | (map (select (.key == "BOSH_DNS")) | map( .value )) as $dns |  map (select (.key == "Hostname")) | map ({ (.value) : $dns  } ) | .[] ' | jq -s 'add' > $BOSH_DNS_ALIASES
